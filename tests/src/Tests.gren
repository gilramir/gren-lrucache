module Tests exposing (..)

import Expect exposing (Expectation)
import Test exposing (..)
import Dict

import LRUCache

suite : Test
suite =
    describe "Cache tests"
        [ describe "Basics"

            [ test "Putting without eviction works" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "a" 1
                                |> Dict.set "b" 2
                                |> Dict.set "c" 3
                                |> Dict.set "d" 4
                                |> Dict.set "e" 5

                        actual =
                            LRUCache.newLRUCache 10 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.put "d" 4
                                |> LRUCache.put "e" 5
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Putting and eviction works" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "b" 2
                                |> Dict.set "c" 3
                                |> Dict.set "d" 4
                                |> Dict.set "e" 5

                        actual =
                            LRUCache.newLRUCache 4 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.put "d" 4
                                |> LRUCache.put "e" 5
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Getting works" <|
                \_ ->
                    let
                        expected =
                            Just 2

                        { cache = _, value = actual } =
                            LRUCache.newLRUCache 4 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.put "d" 4
                                |> LRUCache.put "e" 5
                                |> LRUCache.get "b"
                    in
                        Expect.equal expected actual

            , test "Getting int key works" <|
                \_ ->
                    let
                        expected =
                            Just 2

                        { cache = _, value = actual } =
                            LRUCache.newLRUCache 4 0 0
                                |> LRUCache.put 10 1
                                |> LRUCache.put 20 2
                                |> LRUCache.put 30 3
                                |> LRUCache.put 40 4
                                |> LRUCache.put 50 5
                                |> LRUCache.get 20
                    in
                        Expect.equal expected actual

            , test "Getting Nothing when key has been evicted" <|
                \_ ->
                    let
                        expected =
                            Nothing

                        { cache = _, value = actual } =
                            LRUCache.newLRUCache 2 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.get "a"
                    in
                        Expect.equal expected actual

            , test "Multiple evictions work" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "d" 4
                                |> Dict.set "e" 5

                        actual =
                            LRUCache.newLRUCache 2 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.put "d" 4
                                |> LRUCache.put "e" 5
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Get bumped to the front and changes lru" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "a" 1
                                |> Dict.set "d" 4
                                |> Dict.set "e" 5

                        { cache = cache1, value = _} =
                            LRUCache.newLRUCache 3 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.get "a"

                        actual =
                            cache1
                                |> LRUCache.put "d" 4
                                |> LRUCache.put "e" 5
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Putting the same thing takes expected space" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "a" 1
                                |> Dict.set "b" 2

                        actual =
                            LRUCache.newLRUCache 3 "" 0
                                |> LRUCache.put "a" 5
                                |> LRUCache.put "a" 4
                                |> LRUCache.put "a" 3
                                |> LRUCache.put "a" 2
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Remove an item from the cache" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "a" 1
                                |> Dict.set "c" 3

                        actual =
                            LRUCache.newLRUCache 3 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.remove "b"
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Remove all items" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "a" 1

                        actual =
                            LRUCache.newLRUCache 3 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.remove "b"
                                |> LRUCache.remove "c"
                                |> LRUCache.remove "a"
                                |> LRUCache.put "a" 1
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            , test "Eviction works after deletions" <|
                \_ ->
                    let
                        expected =
                            Dict.empty
                                |> Dict.set "c" 3
                                |> Dict.set "d" 4

                        actual =
                            LRUCache.newLRUCache 2 "" 0
                                |> LRUCache.put "a" 1
                                |> LRUCache.put "b" 2
                                |> LRUCache.put "c" 3
                                |> LRUCache.remove "a"
                                |> LRUCache.put "d" 4
                                |> LRUCache.toDict
                    in
                        Expect.equalDicts expected actual

            ]
        ]
